<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Presentes - Yasmin e Gabriel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .title-font {
            font-family: 'Playfair Display', serif;
        }
        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Animação de entrada */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Estilo para item riscado */
        .item-taken {
            text-decoration: line-through;
            color: #9ca3af; /* text-gray-400 */
        }
        .cursor-not-allowed {
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Container Principal -->
    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">

        <!-- Cabeçalho -->
        <header class="text-center mb-8 fade-in">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-700 title-font">Yasmin & Gabriel</h1>
            <p class="text-lg text-gray-500 mt-2">Nossa Lista de Presentes de Casa Nova</p>
            <div class="mt-4 text-sm text-gray-600 bg-gray-100 p-3 rounded-lg border border-gray-200">
                <p>Selecione um ou mais itens da lista e clique em "Finalizar Escolha". Os itens já escolhidos aparecerão riscados. Obrigado pelo carinho!</p>
            </div>
        </header>

        <!-- Lista de Presentes -->
        <main id="gift-list-container" class="space-y-8">
            <p class="text-center text-gray-500">Carregando lista de presentes...</p>
        </main>

        <!-- Botão Flutuante/Fixo -->
        <footer class="mt-10 text-center sticky bottom-0 py-4 bg-gray-50/80 backdrop-blur-sm">
             <button id="finalize-button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50">
                Finalizar Escolha
            </button>
        </footer>

    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md mx-auto transform transition-all duration-300 ease-out scale-95 opacity-0" id="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Confirmar sua escolha?</h2>
            <p class="text-gray-600 mb-6">Você selecionou os seguintes presentes:</p>
            <ul id="selected-gifts-list" class="list-disc list-inside bg-gray-100 p-4 rounded-lg max-h-48 overflow-y-auto mb-6"></ul>
            <p class="text-sm text-gray-500 mb-6">Ao confirmar, uma nova aba abrirá com o WhatsApp. Depois de enviar a mensagem, os itens serão marcados como escolhidos. <br><strong>(Se a aba não abrir, verifique se seu navegador a bloqueou).</strong></p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-button" class="px-6 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 transition">Cancelar</button>
                <button id="confirm-button" class="px-6 py-2 rounded-lg text-white bg-teal-600 hover:bg-teal-700 transition flex items-center">
                    <span id="confirm-text">Confirmar e Enviar</span>
                    <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Alerta -->
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm mx-auto text-center transform transition-all duration-300 ease-out scale-95 opacity-0" id="alert-modal-content">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Nenhum item selecionado!</h2>
            <p class="text-gray-600 mb-6">Por favor, escolha pelo menos um presente da lista antes de continuar.</p>
            <button id="alert-ok-button" class="px-8 py-2 rounded-lg text-white bg-teal-600 hover:bg-teal-700 transition">Entendi</button>
        </div>
    </div>

    <!-- Firebase SDK e Lógica do Site -->
    <script type="module">
        // Importar funções do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, doc, updateDoc, addDoc, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDoaMvSxuZYY_ikqGMwTqSN6-QKbvqcaa8",
            authDomain: "enxovalcasanova-87db1.firebaseapp.com",
            projectId: "enxovalcasanova-87db1",
            storageBucket: "enxovalcasanova-87db1.appspot.com",
            messagingSenderId: "867167528928",
            appId: "1:867167528928:web:3e00d62194b0db0ea36d85",
            measurementId: "G-P29Y6V7F1X"
        };

        // --- 2. LISTA MESTRA DE PRESENTES ---
        // Para adicionar novos itens, adicione-os aqui e depois execute a função syncGiftList() no console do navegador.
        const initialGiftData = [
            { category: "Cozinha", items: ["Abridor de latas", "Armário", "Assadeiras de alumínio", "Balcão para pia", "Batedeira", "Bule ou cafeteira", "Colher de arroz", "Colheres de chá e sobremesa", "Concha de feijão/sopa", "Conjunto de panelas (pequena, média e grande)", "Copos de vidro (grandes e médios)", "Cuscuzeira", "Descascador de legumes", "Escorredor de louça", "Escorredor de macarrão", "Escumadeira", "Espátulas de silicone", "Filtro de água", "Forma de pudim", "Forma redonda para bolo", "Frigideira antiaderente", "Funil", "Conjunto de facas", "Garrafa térmica", "Jarra para suco", "Lixeira de pia pequena", "Lixeira grande com tampa", "Liquidificador", "Mixer", "Multiprocessador", "Panela de pressão", "Panelas antiaderente", "Panos de prato (sem desenhos, apenas branco)", "Peneira (pequena e média)", "Pipoqueira", "Pia", "Porta-talheres", "Porta-temperos de bancada ou giratório", "Potes de vidro ou plástico (com tampa hermética)", "Potes grandes para arroz, açúcar, farinha, etc.", "Potes pequenos para temperos", "Pratos de sobremesa", "Pratos fundos", "Pratos rasos", "Ralador", "Rodinho de pia", "Sanduicheira", "Suporte para detergente/esponja", "Tábuas de corte", "Talheres (garfo, faca, colher de sopa e sobremesa) - preferência: inteiros, sem cabo de plástico ou emborrachado", "Tesoura de cozinha", "Travessa de vidro/refratário (tipo Marinex)", "Xícaras"] },
            { category: "Sala", items: ["Painel", "Televisão", "Almofadas", "Capas para almofadas", "Cortina", "Manta para sofá"] },
            { category: "Quarto", note: "TAMANHO KING: 2,03m x 1,98M - Caso queira nos presentear com algum desses itens, se possível não escolher estampas ou cores muito chamativas, de preferência tons neutros ou pastéis, sem desenhos de bichos ou flores.", items: ["Ar-condicionado 110 inverter", "Cabides", "Cobertas", "Cortina", "Cobre-leito", "Edredom", "Fronha", "Guarda-roupa", "Lençol", "Peseira", "Pillow Top", "Travesseiro", "Ventilador"] },
            { category: "Limpeza e Organização", items: ["Aspirador", "Baldes", "Difusor", "Mop", "Pá de lixo", "Rodo", "Tábua de passar roupa", "Vassoura"] },
            { category: "Banheiro", items: ["Toalhas de banho", "Toalhas de rosto", "Balcão gabinete para banheiro", "Cuba de sobrepor", "Escova sanitária", "Espelho para banheiro", "Lixeira para banheiro", "Porta-sabonete líquido", "Porta-shampoo", "Saboneteira", "Tapetes para banheiro"] },
            { category: "Outros", items: ["Ferro de passar roupa", "Máquina de lavar"] }
        ];

        // --- 3. FUNÇÕES DE ADMINISTRAÇÃO (para usar no console F12) ---

        // Função para a configuração inicial do banco de dados (USAR SÓ UMA VEZ)
        window.setupInitialList = async () => {
            const db = getFirestore();
            console.log("Iniciando a configuração inicial da lista...");
            let order = 0;
            const promises = initialGiftData.flatMap(category => 
                category.items.map(item => 
                    addDoc(collection(db, "gifts"), {
                        name: item,
                        category: category.category,
                        note: category.note || null,
                        taken: false,
                        order: order++
                    })
                )
            );
            try {
                await Promise.all(promises);
                alert("Lista de presentes inicial carregada no banco de dados com sucesso!");
            } catch (error) {
                console.error("Erro ao carregar os dados: ", error);
                alert("Ocorreu um erro ao carregar a lista. Verifique o console.");
            }
        };

        // Função para adicionar novos itens da lista acima ao banco de dados sem apagar os existentes.
        window.syncGiftList = async () => {
            const db = getFirestore();
            console.log("Iniciando sincronização da lista...");

            const localGiftNames = new Set();
            const localGiftMap = new Map();
            initialGiftData.forEach(category => {
                category.items.forEach(item => {
                    localGiftNames.add(item);
                    localGiftMap.set(item, { category: category.category, note: category.note || null });
                });
            });

            const giftsCol = collection(db, "gifts");
            const q = query(giftsCol);
            const snapshot = await getDocs(q);
            const firestoreGifts = new Set();
            let maxOrder = -1;
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                firestoreGifts.add(data.name);
                if (data.order > maxOrder) {
                    maxOrder = data.order;
                }
            });
            
            const itemsToAdd = [];
            for (const name of localGiftNames) {
                if (!firestoreGifts.has(name)) {
                    const giftInfo = localGiftMap.get(name);
                    maxOrder++;
                    itemsToAdd.push({
                        name: name,
                        category: giftInfo.category,
                        note: giftInfo.note,
                        taken: false,
                        order: maxOrder
                    });
                }
            }

            if (itemsToAdd.length === 0) {
                alert("Nenhum item novo para adicionar. A lista já está sincronizada!");
                return;
            }

            console.log(`Adicionando ${itemsToAdd.length} novo(s) item(ns)...`);
            const promises = itemsToAdd.map(gift => addDoc(collection(db, "gifts"), gift));

            try {
                await Promise.all(promises);
                alert(`${itemsToAdd.length} novo(s) presente(s) adicionado(s) com sucesso! A página será atualizada.`);
                location.reload();
            } catch (error) {
                console.error("Erro ao adicionar novos itens: ", error);
                alert("Ocorreu um erro ao adicionar os novos presentes. Verifique o console.");
            }
        };


        // --- 4. LÓGICA PRINCIPAL DO SITE ---
        document.addEventListener('DOMContentLoaded', () => {
            const giftListContainer = document.getElementById('gift-list-container');
            const finalizeButton = document.getElementById('finalize-button');
            const confirmationModal = document.getElementById('confirmation-modal');
            const modalContent = document.getElementById('modal-content');
            const alertModal = document.getElementById('alert-modal');
            const alertModalContent = document.getElementById('alert-modal-content');
            const cancelButton = document.getElementById('cancel-button');
            const confirmButton = document.getElementById('confirm-button');
            const alertOkButton = document.getElementById('alert-ok-button');
            const selectedGiftsList = document.getElementById('selected-gifts-list');
            const loadingSpinner = document.getElementById('loading-spinner');
            const confirmText = document.getElementById('confirm-text');

            let selectedGifts = {};
            let db;

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const giftsCol = collection(db, "gifts");
                const q = query(giftsCol, orderBy("order"));

                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        giftListContainer.innerHTML = `<p class="text-center text-gray-500">A lista de presentes está vazia. Se você for o dono do site, abra o console (F12) e execute <strong>setupInitialList()</strong> para carregar os itens pela primeira vez.</p>`;
                    } else {
                        const allGifts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderGifts(allGifts);
                    }
                }, (error) => {
                    console.error("Erro ao buscar presentes: ", error);
                    giftListContainer.innerHTML = `<p class="text-red-500 text-center">Não foi possível carregar a lista. Verifique sua conexão e a configuração do Firebase.</p>`;
                });

            } catch (e) {
                console.error("Erro ao inicializar o Firebase. Verifique sua configuração.", e);
                giftListContainer.innerHTML = `<p class="text-red-500 text-center">Erro na configuração do Firebase. Verifique as chaves no código.</p>`;
            }

            const renderGifts = (gifts) => {
                const giftsByCategory = gifts.reduce((acc, gift) => {
                    (acc[gift.category] = acc[gift.category] || []).push(gift);
                    return acc;
                }, {});

                const categoryOrder = initialGiftData.map(c => c.category);

                giftListContainer.innerHTML = '';
                categoryOrder.forEach((categoryName, index) => {
                    const giftsInCategory = giftsByCategory[categoryName];
                    if (!giftsInCategory || giftsInCategory.length === 0) return;

                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'bg-white p-6 rounded-xl shadow-md border border-gray-200 fade-in';
                    categoryDiv.style.animationDelay = `${index * 100}ms`;

                    const categoryTitle = document.createElement('h2');
                    categoryTitle.className = 'text-2xl font-bold text-teal-700 mb-4 border-b-2 border-teal-100 pb-2';
                    categoryTitle.textContent = categoryName;
                    categoryDiv.appendChild(categoryTitle);

                    const note = initialGiftData.find(c => c.category === categoryName)?.note;
                    if (note) {
                        const noteP = document.createElement('p');
                        noteP.className = 'text-sm text-gray-500 italic mb-4 p-3 bg-gray-50 rounded-md';
                        noteP.textContent = note;
                        categoryDiv.appendChild(noteP);
                    }

                    const itemsGrid = document.createElement('div');
                    itemsGrid.className = 'grid grid-cols-1 sm:grid-cols-2 gap-4';
                    
                    giftsInCategory.forEach(gift => {
                        const label = document.createElement('label');
                        label.className = `flex items-center space-x-3 p-3 rounded-lg transition ${gift.taken ? 'cursor-not-allowed' : 'hover:bg-gray-100 cursor-pointer'}`;
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'h-5 w-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500';
                        checkbox.dataset.id = gift.id;
                        checkbox.dataset.name = gift.name;
                        checkbox.disabled = gift.taken;
                        checkbox.checked = !!selectedGifts[gift.id] || gift.taken;
                        checkbox.className += gift.taken ? ' cursor-not-allowed' : ' cursor-pointer';

                        const span = document.createElement('span');
                        span.textContent = gift.name;
                        span.className = `text-gray-700 ${gift.taken ? 'item-taken' : ''}`;

                        label.appendChild(checkbox);
                        label.appendChild(span);
                        itemsGrid.appendChild(label);
                    });

                    categoryDiv.appendChild(itemsGrid);
                    giftListContainer.appendChild(categoryDiv);
                });
            };

            giftListContainer.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox' && !e.target.disabled) {
                    const { id, name } = e.target.dataset;
                    if (e.target.checked) {
                        selectedGifts[id] = name;
                    } else {
                        delete selectedGifts[id];
                    }
                }
            });

            const toggleModal = (modal, content, show) => {
                if (show) {
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        content.classList.remove('opacity-0', 'scale-95');
                        content.classList.add('opacity-100', 'scale-100');
                    }, 10);
                } else {
                    content.classList.remove('opacity-100', 'scale-100');
                    content.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            };
            
            finalizeButton.addEventListener('click', () => {
                if (Object.keys(selectedGifts).length === 0) {
                    toggleModal(alertModal, alertModalContent, true);
                    return;
                }
                selectedGiftsList.innerHTML = '';
                Object.values(selectedGifts).forEach(name => {
                    const li = document.createElement('li');
                    li.textContent = name;
                    li.className = 'text-gray-700';
                    selectedGiftsList.appendChild(li);
                });
                toggleModal(confirmationModal, modalContent, true);
            });

            cancelButton.addEventListener('click', () => toggleModal(confirmationModal, modalContent, false));
            alertOkButton.addEventListener('click', () => toggleModal(alertModal, alertModalContent, false));

            confirmButton.addEventListener('click', async () => {
                confirmButton.disabled = true;
                loadingSpinner.classList.remove('hidden');
                confirmText.classList.add('hidden');

                const phoneNumber = "6699357985";
                const giftText = Object.values(selectedGifts).map(name => `- ${name}`).join('\n');
                const message = encodeURIComponent(`Olá, Yasmin e Gabriel! ✨\nGostaria de presentear vocês com os seguintes itens:\n\n${giftText}\n\nAbraços!`);
                window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');

                const updatePromises = Object.keys(selectedGifts).map(id => {
                    const giftRef = doc(db, "gifts", id);
                    return updateDoc(giftRef, { taken: true });
                });

                try {
                    await Promise.all(updatePromises);
                    
                    selectedGifts = {};
                    toggleModal(confirmationModal, modalContent, false);

                } catch (error) {
                    console.error("Erro ao atualizar os presentes: ", error);
                    alert("Sua mensagem foi aberta no WhatsApp, mas ocorreu um erro ao marcar os presentes no site. Por favor, avisem os noivos!");
                } finally {
                    confirmButton.disabled = false;
                    loadingSpinner.classList.add('hidden');
                    confirmText.classList.remove('hidden');
                }
            });
        });
    </script>
</body>
</html>
